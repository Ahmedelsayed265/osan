{% extends "layout.jinja" %}

{% block header %} {% include 'header.jinja' %} {% endblock %}

{% block top_links %}
<link rel="stylesheet" type="text/css" href="{{ 'toastr.min.css' | asset_url }}" />
<link rel="stylesheet" type="text/css" href="{{ 'ekko-lightbox.css' | asset_url }}" />
<link rel="stylesheet" type="text/css" href="{{ ('product-details.css?v=' ~ ver) | asset_url }}" />
{% endblock %}


{% block main_content %}
<section class="product products-details-page thumb-bottom no-tabs">
    <div class="container">
        <h1 class="title-product">{{ product.name | safe }}</h1>
        <section class="products-details">

            <!--GALLERY-->
            <div id="wrap" class="col-product-image-wrapper">

                <!-- Carousel Thumbs -->
                <div class="product-images-carousel-thumbs swiper-container">
                    <div class="swiper-wrapper">
                        {% for image in product.selected_product.media %}
                        <div class="swiper-slide">
                            <a class="thumb-image-a" data-index="{{ loop.index0 }}" href="javascript:;">
                                <img loading="lazy" src="{{ image.image.medium }}" data-index="{{ loop.index0 }}" alt="image">
                                {% if image.provider and image.link %}
                                <img loading="lazy" id="video-play-icon" class="play-icon"
                                    src="{{ assetUrl('video-play.svg') }}" alt="play" data-index="{{ loop.index0 }}" />
                                {% endif %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Main Carousel -->
                <div class="product-images-carousel product-images-carousel-init {% if product.selected_product.media | length <= 0 %}d-none{% endif %}">
                    {% if product.badge %}
                    {% include 'vitrin:products/badge.jinja' %}
                    {% endif %}

                    <div id="product-images" class="product-images slide gallery">
                        <div id="product-images-slick" class="swiper-container">
                            <div class="swiper-wrapper">
                                {% for image in product.selected_product.media %}
                                <div class="swiper-slide">
                                    <a class="image-link" href="javascript:;">
                                        <img loading="lazy" src="{{ image.image.full_size }}" class="carousel-img"
                                            alt="{{ image.alt_text }}">
                                        {% if image.provider and image.link %}
                                        <img loading="lazy" id="main-video-icon" class="play-icon"
                                            src="{{ assetUrl('video-play.svg') }}" alt="play"
                                            onclick="showIframe(this, '{{ image.link }}')" />
                                        {% endif %}
                                    </a>
                                    {% if image.provider and image.link %}
                                    <div class="iframe-video pt-1 d-none">
                                        <a id="iframe-close-btn" type="button" class="text-white btn btn-none grow"
                                            onClick="hideIframe(this)">X</a>
                                        <iframe width="100%" height="100%" src="" frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen style="max-width: 100%">
                                        </iframe>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </div>
                </div>

                <!-- No image fallback -->
                <div class="product-images-empty {% if product.selected_product.media | length > 0 %}d-none{% endif %}">
                    <div class="content">
                        <img loading="lazy" src="{{ 'product-img.svg' | asset_url }}" width="100%" height="auto" />
                    </div>
                </div>

            </div>

            <div class="col-product-info {% if product.selected_product.media | length <= 1 %}col-product-info-single-image{% endif %}">
                <section>

                    <!-- Short Description -->
                    {% if product.short_description %}
                    <div class="product-description">
                        {{ product.short_description | safe }}
                        &nbsp;
                        <a id="product-description-a" href="#nav-description"
                            class="text-color-primary read-more-btn">{{ _("more information") }}</a>
                    </div>
                    {% endif %}

                    <!-- Product Features (rating, sold count, low stock) -->
                    <div class="d-flex flex-column flex-lg-row product-features">
                        {% if product.rating %}
                        <div>
                            {% set rating = product.rating.average %}
                            {% include 'components/rating-stars.jinja' %}
                            {% if product.rating.total_count > 0 %}
                            <span class="product-card-rating-count">({{ product.rating.total_count }})</span>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if product.sold_products_count %}
                        <div class="product-count d-flex align-items-center">
                            <span class="icon-military_tech" style="color: #FFCF57; font-size: 16px"></span>&nbsp;
                            <span class="lang">{{ _("Sold more than %s times") | format(product.sold_products_count) }}</span>
                        </div>
                        {% elif product.selected_product.sold_products_count %}
                        <div class="product-count d-flex align-items-center">
                            <span class="icon-military_tech" style="color: #FFCF57; font-size: 16px"></span>&nbsp;
                            <span class="lang">{{ _("Sold more than %s times") | format(product.selected_product.sold_products_count) }}</span>
                        </div>
                        {% endif %}

                        {% if product.low_stock_quantity %}
                        <div class="low-quantity-section d-inline-block">
                            <span class="icon-flag_black" style="color: #EC5550; font-size: 16px"></span>&nbsp;
                            <span class="low-quantity">{{ _("Remaining %s only") | format(product.low_stock_quantity) }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Price -->
                    <div class="price-product">
                        <p class="product-formatted-price">
                            {% if product.selected_product.formatted_sale_price %}
                            {{ product.selected_product.formatted_sale_price }}
                            {% else %}
                            {{ product.selected_product.formatted_price }}
                            {% endif %}
                        </p>
                        <p class="price-tawfer {% if not product.selected_product.formatted_sale_price %}d-none{% endif %}">
                            <span class="product-formatted-price-old">
                                {% if product.selected_product.formatted_sale_price %}
                                {{ product.selected_product.formatted_price }}
                                {% endif %}
                            </span>
                            <span class="product-formatted-price-discount">
                                {% if product.selected_product.formatted_sale_price %}
                                - {{ product.discount_percentage }}%
                                {% endif %}
                            </span>
                        </p>
                    </div>

                    <!-- Bundle Offer -->
                    {% if product.bundle_offer %}
                    <div class="bundle-offer-section">
                        <span class="icon-gift" style="color: red; font-size: 14px"></span>&nbsp;
                        <span class="bundle-offer-title">{{ product.bundle_offer.name }}</span>
                    </div>
                    {% endif %}

                    <!-- Loyalty Points -->
                    <div class="loyalty-points">
                        {% include 'vitrin:products/loyalty_points_widget.jinja' %}
                    </div>

                    <!-- Payment Widgets -->
                    <div class="product-payments">
                        {% include 'vitrin:products/payment_widgets.jinja' %}
                    </div>

                    <!-- Lens Title Link -->
                    {% if lens_title is defined and lens_title is not none %}
                    <a href="{% if lens_url is defined and lens_url is not none %}{{ lens_url }}{% else %}javascript:;{% endif %}"
                        class="lens-title">{{ lens_title }}</a>
                    {% endif %}

                    <!-- Product Form -->
                    <form id="product-form">
                        <input id="product-id" type="hidden" value="{{ product.selected_product.id }}">

                        <div class="size-box">
                            {% include 'vitrin:products/variants_list.jinja' %}

                            {% if product.custom_input_fields %}
                            {% include 'vitrin:products/custom_input_fields.jinja' %}
                            {% endif %}
                        </div>

                        <!-- Total Prices Box (for lens products) -->
                        <div class="total-prices-box" id="total-prices-box" style="display: none;">
                            <p>
                                {% if product_price_default_label %}
                                {{ product_price_default_label }}
                                {% else %}
                                {{ _("Product price") }}
                                {% endif %} :
                                <span class="price-item product-price-default">
                                    {% if product.selected_product.sale_price %}
                                    {{ product.selected_product.sale_price }}
                                    {% else %}
                                    {{ product.selected_product.price }}
                                    {% endif %}
                                </span>
                                {{ session.currency.code }}
                            </p>
                            <p>
                                {% if lens_color_price_label is defined and lens_color_price_label is not none %}
                                {{ lens_color_price_label }}
                                {% else %}
                                {{ _("Lens color price") }}
                                {% endif %} :
                                <span class="price-item lens-color-price">0</span>
                                {{ session.currency.code }}
                            </p>
                            <p>
                                {% if lens_detail_price_label is defined and lens_detail_price_label is not none %}
                                {{ lens_detail_price_label }}
                                {% else %}
                                {{ _("Lens detail price") }}
                                {% endif %} :
                                <span class="price-item lens-detail-price">0</span>
                                {{ session.currency.code }}
                            </p>
                            <p>
                                {% if package_price_label is defined and package_price_label is not none %}
                                {{ package_price_label }}
                                {% else %}
                                {{ _("Package price") }}
                                {% endif %} :
                                <span class="price-item package-price">0</span>
                                {{ session.currency.code }}
                            </p>
                            <p>
                                {% if total_price_label is defined and total_price_label is not none %}
                                {{ total_price_label }}
                                {% else %}
                                {{ _("Total price") }}
                                {% endif %} :
                                <span class="total-price--final">0</span>
                                {{ session.currency.code }}
                            </p>
                        </div>

                        <!-- Quantity -->
                        {% if product.selected_product.is_infinite or product.selected_product.quantity > 0 %}
                        <div class="quantity-add-cart column--quantity">
                            <label>{{ _("Quantity") }}</label>
                            <div class="select-quantity-div">
                                <div class="quantity-input">
                                    <button type="button" id="increase-quantity" class="btn-quantity"
                                        aria-label="increase-quantity">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                                            height="24" color="#ffffff" fill="none">
                                            <path d="M12 4V20M20 12H4" stroke="currentColor" stroke-width="1.5"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                    <input type="number" id="product-quantity" aria-label="quantity" name="quantity"
                                        class="select-quantity" min="1" value="1" readonly>
                                    <button type="button" id="decrease-quantity" class="btn-quantity"
                                        aria-label="decrease-quantity">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                                            height="24" color="#ffffff" fill="none">
                                            <path d="M20 12L4 12" stroke="currentColor" stroke-width="1.5"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Out of Stock Notify Me -->
                        <div class="section-out-of-stock-notify-me {% if not product.selected_product.in_stock %}d-block{% else %}d-none{% endif %}">
                            <h3 class="product-title">{{ _("This product is out of stock") }}</h3>
                            <form>
                                <input type="hidden" class="send-notify-product-id"
                                    value="{{ product.selected_product.id }}">
                                <h4>{{ _("Notify me when product is available") }}</h4>
                                <div class="form-notify-me">
                                    <div class="form-group">
                                        <input class="form-control send-notify-name" value="" type="text"
                                            placeholder="{{ _('Enter your name') }}" />
                                    </div>
                                    <div class="form-group">
                                        <input class="form-control send-notify-email" type="email" value=""
                                            placeholder="{{ _('Enter your email') }}" />
                                    </div>
                                    <div class="form-group">
                                        <div class="form-notify-me-phone-row">
                                            <input class="form-control send-notify-phone" type="number" value=""
                                                placeholder="{{ _('Enter your phone (Optional)') }}" maxlength="10" />
                                            <input class="form-control send-notify-country-key" type="number"
                                                placeholder="966" maxlength="4" />
                                        </div>
                                    </div>
                                    <div class="form-notify-me-submit-button-row">
                                        <button type="button" class="btn btn-primary btn-send-notify"
                                            onclick="sendProductNotifyMe()">
                                            <img loading="lazy" class="send-notify-progress d-none"
                                                src="{{ asset_url }}spinner.gif" width="15" height="15" />
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                                                height="24" color="#ffffff" fill="none">
                                                <path
                                                    d="M21.0477 3.05293C18.8697 0.707363 2.48648 6.4532 2.50001 8.551C2.51535 10.9299 8.89809 11.6617 10.6672 12.1581C11.7311 12.4565 12.016 12.7625 12.2613 13.8781C13.3723 18.9305 13.9301 21.4435 15.2014 21.4996C17.2278 21.5892 23.1733 5.342 21.0477 3.05293Z"
                                                    stroke="currentColor" stroke-width="1.5" />
                                                <path d="M11.5 12.5L15 9" stroke="currentColor" stroke-width="1.5"
                                                    stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                            {{ _("Send") }}
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </form>

                    <!-- Bundle Product Selection (dynamic_bundle) -->
                    {% if product.product_class == 'dynamic_bundle' %}
                    {% include 'vitrin:products/bundle-products.jinja' %}
                    {% endif %}

                </section>

                <!-- Product Buttons -->
                <div class="product-buttons {% if not product.selected_product.in_stock %}d-none{% else %}d-block{% endif %}">
                    <div class="product-buttons-flex add-cart-page" style="gap: 10px;">
                        <button class="btn-add-to-cart" type="button" onclick="productAddToCart()">
                            <img class="add-to-cart-progress d-none" src="{{ 'spinner.gif' | asset_url }}" width="25" height="25"/>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                                color="#000000" fill="none">
                                <path
                                    d="M3.87289 17.0194L2.66933 9.83981C2.48735 8.75428 2.39637 8.21152 2.68773 7.85576C2.9791 7.5 3.51461 7.5 4.58564 7.5H19.4144C20.4854 7.5 21.0209 7.5 21.3123 7.85576C21.6036 8.21152 21.5126 8.75428 21.3307 9.83981L20.1271 17.0194C19.7282 19.3991 19.5287 20.5889 18.7143 21.2945C17.9 22 16.726 22 14.3782 22H9.62182C7.27396 22 6.10003 22 5.28565 21.2945C4.47127 20.5889 4.27181 19.3991 3.87289 17.0194Z"
                                    stroke="currentColor" stroke-width="1.5"></path>
                                <path d="M17.5 7.5C17.5 4.46243 15.0376 2 12 2C8.96243 2 6.5 4.46243 6.5 7.5"
                                    stroke="currentColor" stroke-width="1.5"></path>
                            </svg>
                            <span>{{ _("add to cart") }}</span>
                        </button>

                        <!-- Buy Now Button -->
                        <button class="btn-buy-now" type="button" onclick="zidProductBuyNow()">
                            <img class="buy-now-progress d-none" src="{{ 'spinner.gif' | asset_url }}" width="25" height="25" />
                            <span>{{ _("Buy now") }}</span>
                        </button>

                        {% if store.settings.products.wishlist_enabled == true %}
                        <span class="add-to-wishlist" data-wishlist-id="{{ product.id }}">
                            {% if not session.is_guest %}
                            <a class="icon-heart-mask" onclick="addToWishlist(this, '{{ product.id }}')"></a>
                            {% else %}
                            <a class="icon-heart-mask"
                                href="{{ url_for('login_page', query_params={'redirect_to': requestUri()}) }}"></a>
                            {% endif %}
                            <img class="loader d-none" src="{{ asset_url }}spinner.gif" width="20" height="20" />
                        </span>
                        {% endif %}
                    </div>

                    <div class="apple-pay-button">
                        {% include 'vitrin:checkout/apple-pay-quick-checkout.jinja' %}
                    </div>
                </div>

                <div id="product-view-add-to-cart"></div>

                <!-- Description & Tabs -->
                <div class="tp-product-details-tab-nav tp-tab">
                    <div class="tab-content" id="navPresentationTabContent">

                        {% if product.description %}
                        <div class="tab-pane" id="nav-description" role="tabpanel"
                            aria-labelledby="nav-description-tab">
                            <div class="description-box">
                                {{ product.description | safe }}
                            </div>
                        </div>
                        {% endif %}

                        {% if product.metafields %}
                        <div class="tab-pane" id="nav-metafields" role="tabpanel"
                            aria-labelledby="nav-metafields-tab" style="display: none;">
                            <div class="tp-title-section">
                                <h3>{{ _("product information") }}</h3>
                            </div>
                            <div class="description-paragrah">
                                {% set entity = product %}
                                {% include 'vitrin:shared/metafields.jinja' %}
                            </div>
                        </div>
                        {% endif %}

                        {% if product.has_variants %}
                        <div class="tab-pane" id="nav-variants" role="tabpanel"
                            aria-labelledby="nav-variants-tab" style="display: none;">
                            <div class="card-table d-none d-lg-block">
                                <div class="card">
                                    <div class="card-body card-table-header">
                                        <div class="row">
                                            {% for option in product.options %}
                                            <div class="col">{{ option.name }}</div>
                                            {% endfor %}
                                            <div class="col col-price">{{ _("Product images") }}</div>
                                            <div class="col col-price">{{ _("price") }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% for variant in product.variants %}
                            {% if variant.in_stock %}
                            <div class="card-table options-table">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row flex-column flex-lg-row align-items-start align-items-lg-center">
                                            {% for attribute in variant.attributes %}
                                            <div class="col m-col">
                                                <span class="variant-name-sm d-inline-block d-lg-none">
                                                    {{ product.options[loop.index0].name }}
                                                </span>
                                                <span>{{ attribute.value }}</span>
                                            </div>
                                            {% endfor %}

                                            <div class="col">
                                                {% if variant.images | length > 0 %}
                                                <div class="d-flex m-col">
                                                    {% for image in variant.images %}
                                                    <div class="variant-image-wrapper" data-var-id="{{ variant.id }}">
                                                        <div class="box-1-1">
                                                            <div class="content">
                                                                <a data-index="{{ loop.index0 }}"
                                                                    data-link-var-id="{{ variant.id }}"
                                                                    class="d-flex align-items-center justify-content-center"
                                                                    style="width: 100%; height: 100%;"
                                                                    href="javascript:;">
                                                                    <img loading="lazy" src="{{ image.image.medium }}"
                                                                        data-image-url="{{ image.image.full_size }}">
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <span class="d-none d-lg-inline">{{ _("No images") }}</span>
                                                {% endif %}
                                            </div>

                                            <div class="col m-col">
                                                <span class="variant-name-sm d-inline-block d-lg-none">{{ _("price") }}</span>
                                                {% if variant.formatted_sale_price %}
                                                <h4 style="font-size: 1.2rem" class="price-detail d-inline-block">
                                                    {{ variant.formatted_sale_price }}
                                                    <del>{{ variant.formatted_price }}</del>
                                                </h4>
                                                {% else %}
                                                <h4 class="d-inline-block" style="font-size: 1.2rem">
                                                    {{ variant.formatted_price }}
                                                </h4>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Bottom Section: Bundle Offer -->
    <div class="tp-product-bottom">
        <div class="container">
            {% if product.bundle_offer %}
            <section class="bundle-offer-details-section s-block">
                <div class="flex-bundle">
                    <div class="description-icon">
                        <span class="icon-gift"></span>
                    </div>
                    <div class="description-title">
                        <div class="bundle-offer-title">{{ product.bundle_offer.name }}</div>
                        <div class="bundle-offer-title-description">{{ product.bundle_offer.description }}</div>
                    </div>
                </div>
                <div class="description-paragrah">
                    <div class="bundle-offer-products">
                        <div class="bundle-offer-details-products products-grid">
                            {% for bp in product.bundle_offer.products.results[:5] %}
                            {% set product = bp %}
                            {% set index = loop.index0 %}
                            {% include 'components/product-card.jinja' %}
                            {% endfor %}
                        </div>
                    </div>
                    {% if product.bundle_offer.products.results | length > 5 %}
                    <div class="bundle-offer-more">
                        <a class="tp-btn" href="javascript:;" data-bs-toggle="modal"
                            data-bs-target=".bd-example-modal-lg">
                            {{ _("Display all products") }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </section>
            {% endif %}
        </div>
    </div>

    <!-- Bottom Section: Grouped Products & Related Products -->
    <div class="tp-product-bottom">
        <div class="container">
            {% include 'vitrin:products/grouped-product.jinja' %}

            {% if product.related_products | length > 0 %}
            <section class="tp-product-card s-block">
                <div class="tp-title-section">
                    <h3>{{ _("You may also like") }}</h3>
                </div>
                <div class="products-slider-wrapper" style="position: relative">
                    <div id="related-products" class="products-slider s-slider d-block">
                        {% for rProduct in product.related_products %}
                        <div class="prod-col">
                            {% set product = rProduct %}
                            {% set index = loop.index0 %}
                            {% include 'components/product-card.jinja' %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>

            <script>
                var showRelatedProducts = function () {
                    var arrowNextClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_right' : 'icon-keyboard_arrow_left';
                    var arrowPrevClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_left' : 'icon-keyboard_arrow_right';
                    var $slider = $('#related-products');
                    if ($slider.length && !$slider.hasClass('slick-initialized')) {
                        $slider.slick({
                            slidesToShow: 5,
                            slidesToScroll: 5,
                            infinite: false,
                            autoplay: true,
                            autoplaySpeed: 3000,
                            arrows: true,
                            dots: false,
                            rtl: !(window.appDirection === 'ltr'),
                            nextArrow: '<button class="slick-next slick-arrow" aria-label="Next" type="button"><span class="' + arrowNextClass + '"></span></button>',
                            prevArrow: '<button class="slick-prev slick-arrow" aria-label="Previous" type="button"><span class="' + arrowPrevClass + '"></span></button>',
                            responsive: [
                                { breakpoint: 1200, settings: { slidesToShow: 5, slidesToScroll: 5 } },
                                { breakpoint: 1024, settings: { slidesToShow: 4, slidesToScroll: 4 } },
                                { breakpoint: 768,  settings: { slidesToShow: 3, slidesToScroll: 3 } },
                                { breakpoint: 450,  settings: { slidesToShow: 2, slidesToScroll: 2 } },
                                { breakpoint: 350,  settings: { slidesToShow: 1, slidesToScroll: 1 } }
                            ]
                        });
                        $slider.on('afterChange', function (event, slick, currentSlide) {
                            var totalSlides = slick.slideCount;
                            var slidesToShow = slick.options.slidesToShow;
                            if (currentSlide + slidesToShow >= totalSlides) {
                                $slider.slick('slickSetOption', 'autoplay', false);
                            }
                        });
                    }
                };
                document.addEventListener("DOMContentLoaded", function () {
                    if (typeof showRelatedProducts === 'function') {
                        showRelatedProducts();
                    }
                });
            </script>
            {% endif %}
        </div>
    </div>
</section>

<!-- Bundle Offer Modal (full list) -->
{% if product.bundle_offer and product.bundle_offer.products.results | length > 5 %}
<div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen modal-dialog-scrollable bundle-offer-products-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"
                    style="font-size: 40px;">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="bundle-offer-products">
                    <div class="bundle-offer-details-products-all products-grid">
                        <div class="row bundle-offer-details-products-all">
                            {% for bp in product.bundle_offer.products.results %}
                            <div class="prod-col prod-col-tb">
                                {% set product = bp %}
                                {% set index = loop.index0 %}
                                {% include 'components/product-card.jinja' %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Product Questions -->
{% if store.settings.products.questions_enabled %}
    {% set product=product %} {% include 'components/product-question-add.jinja' %}
{% endif %}

<!-- Sticky Cart -->
<div class="sticky-cart">
    <img loading="lazy" class="product-img" src="{{ product.selected_product.images[0].image.small }}">
    <div class="product-name-price">
        <h3 class="title-product">{{ product.name | safe }}</h3>
        <div class="product-price-div">
            <p class="product-formatted-price">
                {% if product.selected_product.formatted_sale_price %}
                {{ product.selected_product.formatted_sale_price }}
                {% else %}
                {{ product.selected_product.formatted_price }}
                {% endif %}
            </p>
            <p class="price-tawfer mb-0 {% if not product.selected_product.formatted_sale_price %}d-none{% endif %}">
                <span class="product-formatted-price-old">
                    {% if product.selected_product.formatted_sale_price %}
                    {{ product.selected_product.formatted_price }}
                    {% endif %}
                </span>
            </p>
        </div>
    </div>

    {% if product.selected_product.is_infinite or product.selected_product.quantity > 0 %}
    <div class="select-quantity-div">
        <div class="quantity-input">
            <button type="button" id="increase-quantity" class="btn-quantity">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff"
                    fill="none">
                    <path d="M12 4V20M20 12H4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>
            <input type="number" id="product-quantity" aria-label="quantity" name="quantity"
                class="select-quantity" min="1" value="1" readonly>
            <button type="button" id="decrease-quantity" class="btn-quantity">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" color="#ffffff"
                    fill="none">
                    <path d="M20 12L4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </div>
    {% endif %}

    <div class="product-buttons {% if not product.selected_product.in_stock %}d-none{% else %}d-block{% endif %}">
        <div class="product-buttons-flex">
            <button class="btn-add-to-cart" type="button" onclick="productAddToCart()">
                <img loading="lazy" class="add-to-cart-progress d-none" src="{{ asset_url }}spinner.gif"
                    width="25" height="25" />
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                    color="#000000" fill="none">
                    <path
                        d="M3.87289 17.0194L2.66933 9.83981C2.48735 8.75428 2.39637 8.21152 2.68773 7.85576C2.9791 7.5 3.51461 7.5 4.58564 7.5H19.4144C20.4854 7.5 21.0209 7.5 21.3123 7.85576C21.6036 8.21152 21.5126 8.75428 21.3307 9.83981L20.1271 17.0194C19.7282 19.3991 19.5287 20.5889 18.7143 21.2945C17.9 22 16.726 22 14.3782 22H9.62182C7.27396 22 6.10003 22 5.28565 21.2945C4.47127 20.5889 4.27181 19.3991 3.87289 17.0194Z"
                        stroke="currentColor" stroke-width="1.5"></path>
                    <path d="M17.5 7.5C17.5 4.46243 15.0376 2 12 2C8.96243 2 6.5 4.46243 6.5 7.5"
                        stroke="currentColor" stroke-width="1.5"></path>
                </svg>
                <span>{{ _("add to cart") }}</span>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block footer %}
{% include 'footer.jinja' %}
{% endblock %}

{% block footer_scripts %}

<script type="text/javascript" src="{{ 'ekko-lightbox.min.js' | asset_url }}" defer></script>
<script type="text/javascript" src="{{ 'product-details.js' | asset_url }}" defer></script>
<script type="text/javascript" src="{{ 'toastr.min.js' | asset_url }}" defer></script>
<script type="text/javascript" src="{{ 'options.js' | asset_url }}" defer></script>

{{ product_view_scripts | safe }}

<script>
    var store_currency = '{{ session.currency.code }}';
    var store_lang = '{{ session.lang.code }}';
    var productImages = {{ product.selected_product.media | tojson }};
    var customerWishlistIds = {{ customer.wishlist | tojson if customer else '[]' }};

    // ========================================================
    // إظهار / إخفاء total-prices-box بناءً على حقول العدسات
    // ========================================================
    document.addEventListener("DOMContentLoaded", function () {
        var sizeBox = document.querySelector('.size-box');
        var totalPricesBox = document.getElementById('total-prices-box');
        if (!sizeBox || !totalPricesBox) return;

        var namedFields = Array.from(sizeBox.querySelectorAll('[name]'));

        var lensQuestion = namedFields.find(function (el) {
            return el.name && (el.name.includes('تفصيل عدسات') || el.name.includes('تفصيل عدسي'));
        });
        var lensColor = namedFields.find(function (el) {
            return el.name && (el.name.includes('لون العدسات') || el.name.includes('لون العدسي'));
        });
        var lensPackage = namedFields.find(function (el) {
            return el.name && (el.name.includes('باقة') || el.name.includes('باقه'));
        });

        totalPricesBox.style.display = (lensQuestion || lensColor || lensPackage) ? '' : 'none';
    });

    // ========================================================
    // Buy Now Function
    // ========================================================
    window.zidProductBuyNow = async () => {
        const buyNowLoading = (isLoading) => {
            const buttonElement = $('.btn-buy-now');
            const loaderElement = $('.buy-now-progress');
            
            buttonElement.prop('disabled', isLoading);
            loaderElement.toggleClass('d-none', !isLoading);
        };
        
        // Check if form is valid
        var form = document.getElementById('product-form');
        if (form && !form.checkValidity()) {
            form.querySelectorAll(':invalid').forEach(function (el) {
                el.classList.add('is-invalid');
            });
            toastr.error('الرجاء تعبئة الحقول المطلوبة بشكل صحيح.');
            var firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) firstInvalid.focus();
            return;
        }
        
        const bundlePayload = window.bundleCartPayload;
        const addProductOptions = bundlePayload ? 
            { ...bundlePayload, form_id: 'product-form' } : 
            { form_id: 'product-form' };

        try {
            buyNowLoading(true);
            const response = await window.zid.cart.buyNow(addProductOptions, { showErrorNotification: true });
            buyNowLoading(false);
        } catch(error) {
            console.error(error, 'Buy Now failed');
            buyNowLoading(false);
        }
    };

    // ========================================================
    // إضافة المنتج إلى السلة
    // ========================================================
    function productAddToCart() {
        var addToCartBtn = document.querySelector('.btn-add-to-cart');
        if (addToCartBtn && addToCartBtn.disabled) return;
        if (!$('.add-to-cart-progress').hasClass('d-none')) return;

        var form = document.getElementById('product-form');
        if (form && !form.checkValidity()) {
            form.querySelectorAll(':invalid').forEach(function (el) {
                el.classList.add('is-invalid');
            });
            toastr.error('الرجاء تعبئة الحقول المطلوبة بشكل صحيح.');
            var firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) firstInvalid.focus();
            return;
        }

        $('.add-to-cart-progress').removeClass('d-none');

        var bundlePayload = window.bundleCartPayload;
        var addProductOptions = bundlePayload
            ? Object.assign({}, bundlePayload, { form_id: 'product-form' })
            : { form_id: 'product-form' };

        window.zid.cart.addProduct(addProductOptions, { showErrorNotification: true }).then(function (response) {
            if (response && response.item && response.cart_items_quantity) {
                $('.cart-badge').removeClass('d-none').text(response.cart_items_quantity);

                if (typeof fetchCart === 'function') fetchCart();

                toastr.success('{{ _("Added to cart successfully") }}');
                $('.added-notification').addClass('show');

                showCartPopupAfterAdd();
                
                setTimeout(function () {
                    $('.added-notification').removeClass('show');
                }, 5000);

                var image = $('#product-images-slick .swiper-slide.swiper-slide-active img');
                var cart = $('.a-shopping-cart');
                if (image.length && cart.length && typeof addToCartAnimation === 'function') {
                    addToCartAnimation(cart, image);
                }
            } else {
                var errorMessage = (response && response.message) ? response.message : '{{ _("Failed to add to cart") }}';
                toastr.error(errorMessage);
            }
            $('.add-to-cart-progress').addClass('d-none');
        }).catch(function () {
            $('.add-to-cart-progress').addClass('d-none');
        });
    }

    // ========================================================
    // Bundle Selection Handler
    // ========================================================
    window.addEventListener('vitrin:bundle-selections:updated', function(event) {
        const cartData = event?.detail?.data;
        const bundlePayload = cartData?.cartPayload;
        const isValid = cartData?.isSelectionsValid;

        window.bundleCartPayload = bundlePayload;

        const buyNowButton = $('.btn-buy-now');
        const addToCartBtn = document.querySelector('.btn-add-to-cart');

        if (addToCartBtn) {
            if (!isValid) {
                addToCartBtn.classList.add('disabled');
                addToCartBtn.disabled = true;
                buyNowButton.prop('disabled', true);
            } else {
                addToCartBtn.classList.remove('disabled');
                addToCartBtn.disabled = false;
                buyNowButton.prop('disabled', false);
            }
        }
    });

    // ========================================================
    // تغيير خيارات المنتج (variants)
    // ========================================================
    function productOptionsChanged(selected_product) {
        if (selected_product) {
            $('#product-id').val(selected_product.id);
            $('.send-notify-product-id').val(selected_product.id);

            if (selected_product.in_stock) {
                // تحديث السعر
                if (selected_product.formatted_sale_price) {
                    $('.product-formatted-price').html(selected_product.formatted_sale_price);
                    $('.product-formatted-price-old').html(selected_product.formatted_price);
                    $('.product-formatted-price-discount').html('- ' + selected_product.discount_percentage + '%');
                    $('.price-tawfer').removeClass('d-none');
                } else {
                    $('.product-formatted-price').html(selected_product.formatted_price);
                    $('.product-formatted-price-old').html('');
                    $('.product-formatted-price-discount').html('');
                    $('.price-tawfer').addClass('d-none');
                }

                if (typeof formatPrices === 'function') formatPrices();

                // الوزن
                if (selected_product.weight && selected_product.weight.value) {
                    $('.div-product-weight').removeClass('d-none');
                    $('.div-product-weight .product-weight').html(selected_product.weight.value + ' ' + selected_product.weight.unit);
                } else {
                    $('.div-product-weight').addClass('d-none');
                }

                // SKU
                if (selected_product.sku) {
                    $('.div-product-sku').removeClass('d-none');
                    $('.div-product-sku .product-sku').html(selected_product.sku);
                } else {
                    $('.div-product-sku').addClass('d-none');
                }

                {% if store.settings.products.low_stock_label_enabled %}
                var store_low_stock_limit = {{ store.settings.products.low_stock_quantity_threshold }};
                var low_stock_message = '{{ _("Remaining %s only") }}';
                if (!selected_product.is_infinite && selected_product.quantity < store_low_stock_limit) {
                    $('.low-quantity-section').removeClass('d-none').addClass('d-inline-block');
                    $('.low-quantity-section .low-quantity').html(low_stock_message.replace('%s', selected_product.quantity));
                } else {
                    $('.low-quantity-section').removeClass('d-inline-block').addClass('d-none');
                }
                {% endif %}

                // عداد المبيعات
                var sold_count_msg = '{{ _("Sold more than %s times") }}';
                if (selected_product.sold_products_count) {
                    $('.product-count').removeClass('d-none').addClass('d-flex');
                    $('.product-count .lang').html(sold_count_msg.replace('%s', selected_product.sold_products_count));
                } else {
                    $('.product-count').removeClass('d-flex').addClass('d-none');
                }

                // الكمية
                if (selected_product.is_infinite) selected_product.quantity = 100;
                var selectQuantity = '';
                if (selected_product.quantity > 0) {
                    $('.quantity-add-cart').removeClass('d-none');
                    var quantityMax = (selected_product.quantity > 100) ? 100 : selected_product.quantity;
                    selectQuantity = '<option value="1" selected>1</option>';
                    for (var i = 2; i <= quantityMax; i++) {
                        selectQuantity += '<option value="' + i + '">' + i + '</option>';
                    }
                } else {
                    $('.quantity-add-cart').addClass('d-none');
                }
                $('.select-quantity').html(selectQuantity);

                $('.product-buttons').removeClass('d-none');
                $('.section-out-of-stock-notify-me').addClass('d-none');
                $('.btn-add-to-cart span').html('{{ _("add to cart") }}');

                updateProductImages(selected_product);

            } else {
                // الخيار غير متوفر (نفد المخزون)
                if (typeof formatPrices === 'function') formatPrices();

                $('.quantity-add-cart').addClass('d-none');
                $('.product-buttons').addClass('d-none');
                $('.section-out-of-stock-notify-me').removeClass('d-none');
                $('.btn-add-to-cart span').html('{{ _("Option not available") }}');

                if (selected_product.sku) {
                    $('.div-product-sku').removeClass('d-none');
                    $('.div-product-sku .product-sku').html(selected_product.sku);
                } else {
                    $('.div-product-sku').addClass('d-none');
                }

                updateProductImages(selected_product);
            }
        } else {
            // الخيار غير موجود أصلاً
            $('.quantity-add-cart').addClass('d-none');
            $('.product-buttons').addClass('d-none');
            $('.section-out-of-stock-notify-me').removeClass('d-none');
            $('.btn-add-to-cart span').html('{{ _("Option not available") }}');
            updateProductImages(selected_product);
        }
    }

    // ========================================================
    // تحديث صور المنتج عند تغيير الخيار
    // ========================================================
    function updateProductImages(selected_product) {
        if (selected_product && selected_product.media && selected_product.media.length > 0) {
            $('.product-images-carousel').removeClass('d-none');
            $('.product-images-carousel-thumbs').removeClass('d-none-important');
            $('.product-images-empty').addClass('d-none');

            // تدمير Swiper القديم إن وُجد
            if (typeof modalThumbsSwiper !== 'undefined') { try { modalThumbsSwiper.destroy(true, true); } catch(e) {} }
            if (typeof swiper_main !== 'undefined') { try { swiper_main.destroy(true, true); } catch(e) {} }

            $('.product-images-carousel').addClass('product-images-carousel-init');
            productImages = selected_product.media;

            $('#product-images-slick .swiper-wrapper').html('');
            $('.product-images-carousel-thumbs .swiper-wrapper').html('');

            for (var z = 0; z < productImages.length; z++) {
                var prImage = productImages[z];
                var videoBtn = '';
                var videoThumbBtn = '';
                if (prImage.provider && prImage.link) {
                    videoBtn = '<img loading="lazy" id="main-video-icon" class="play-icon" src="{{ assetUrl("video-play.svg") }}" alt="play" onclick="showIframe(this, \'' + prImage.link.replace(/'/g, "\\'") + '\')" />';
                    videoThumbBtn = '<img loading="lazy" id="video-play-icon" class="play-icon" src="{{ assetUrl("video-play.svg") }}" alt="play" data-index="' + z + '">';
                }

                $('#product-images-slick .swiper-wrapper').append(
                    '<div class="swiper-slide">' +
                        '<a class="image-link" href="javascript:;">' +
                            '<img loading="lazy" src="' + (prImage.image ? prImage.image.full_size : '') + '" class="carousel-img" alt="' + (selected_product.name || '') + '">' +
                            videoBtn +
                        '</a>' +
                        '<div class="iframe-video pt-1 d-none">' +
                            '<a id="iframe-close-btn" class="text-white btn btn-none grow" onClick="hideIframe(this)">X</a>' +
                            '<iframe width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="max-width: 100%;"></iframe>' +
                        '</div>' +
                    '</div>'
                );

                $('.product-images-carousel-thumbs .swiper-wrapper').append(
                    '<div class="swiper-slide">' +
                        '<a class="thumb-image-a" data-index="' + z + '" href="javascript:;">' +
                            '<img loading="lazy" src="' + (prImage.image ? prImage.image.medium : '') + '" data-index="' + z + '" alt="image">' +
                            videoThumbBtn +
                        '</a>' +
                    '</div>'
                );
            }

            initSlick(productImages);
            if (typeof applyFixedMediaHeightFromFirst === 'function') {
                applyFixedMediaHeightFromFirst();
            }
        } else {
            $('.product-images-carousel').addClass('d-none');
            $('.product-images-carousel-thumbs').addClass('d-none-important');
            $('.product-images-empty').removeClass('d-none');
        }
    }

    // ========================================================
    // إشعار توفر المنتج
    // ========================================================
    function sendProductNotifyMe() {
        if (!$('.send-notify-progress').hasClass('d-none')) return;

        $('.send-notify-progress').removeClass('d-none');
        var countryCode = '+' + ($('.send-notify-country-key').val() || '966');
        var productId = $('.send-notify-product-id').val();
        var email = $('.send-notify-email').val();
        var name = $('.send-notify-name').val();
        var phone = '';
        var rawPhone = $('.send-notify-phone').val();
        if (rawPhone) phone = countryCode + rawPhone;

        var baseUrl = "{{ store.permalink }}";
        var payload = { customer_email: email, customer_phone_number: phone, customer_name: name };
        var url = baseUrl + 'api/v1/products/' + encodeURIComponent(productId) + '/stock-alerts';

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(function (res) {
            if (res.ok) {
                return res.json().then(function (data) {
                    if (!data || data.status === 'success') {
                        toastr.success('{{ _("Send Successfully") }}');
                    } else if (data && data.data && data.data.message) {
                        toastr.error(JSON.stringify(data.data.message));
                    } else {
                        toastr.error('{{ _("failed to send") }}');
                    }
                }).catch(function () {
                    toastr.success('{{ _("Send Successfully") }}');
                });
            } else {
                return res.json().then(function (errData) {
                    var msg = (errData && errData.data && errData.data.message)
                        || (errData && errData.detail)
                        || 'HTTP ' + res.status;
                    toastr.error(msg);
                }).catch(function () {
                    toastr.error('{{ _("failed to send") }}');
                });
            }
        }).catch(function () {
            toastr.error('{{ _("Failed to send alert request") }}');
        }).finally(function () {
            $('.send-notify-progress').addClass('d-none');
        });
    }

    // ========================================================
    // Scroll to description
    // ========================================================
    $('#product-description-a').on('click', function (event) {
        event.preventDefault();
        var target = $($.attr(this, 'href'));
        if (target.length) {
            $('html, body').animate({
                scrollTop: target.offset().top - (window.matchMedia('(max-width: 768px)').matches ? 15 : 150)
            }, 500);
        }
    });

    // ========================================================
    // ضبط ارتفاع الصور في الموبايل
    // ========================================================
    function applyFixedMediaHeightFromFirst() {
        if (window.innerWidth > 768) return;
        var $firstImg = $('#product-images-slick .swiper-slide img.carousel-img').first();
        if (!$firstImg.length) return;

        var setHeights = function (h) {
            if (!h || h <= 0) return;
            var px = h + 'px';
            var $container = $('#product-images-slick');
            $container.css('height', px);
            $container.find('.swiper-wrapper').css('height', px);
            $container.find('.swiper-slide').css('height', px);
        };

        var imgEl = $firstImg.get(0);
        if (imgEl.complete && imgEl.naturalHeight) {
            setHeights($firstImg.height());
        } else {
            $firstImg.on('load', function () { setHeights($firstImg.height()); });
        }
    }

    // ========================================================
    // تهيئة Swiper
    // ========================================================
    var modalThumbsSwiper, swiper_main;

    var initSlick = function (imgs) {
        if (window.innerWidth <= 768) {
            modalThumbsSwiper = new Swiper('.product-images-carousel-thumbs', {
                slidesPerView: 5,
                spaceBetween: 10,
                watchOverflow: true,
                watchSlidesVisibility: true,
                watchSlidesProgress: true,
                direction: 'horizontal',
                breakpoints: {
                    0:   { slidesPerView: 3 },
                    450: { slidesPerView: 4 },
                    768: { slidesPerView: 5 }
                }
            });

            swiper_main = new Swiper('#product-images-slick', {
                slidesPerView: 1,
                spaceBetween: 0,
                loop: true,
                watchOverflow: true,
                watchSlidesVisibility: true,
                watchSlidesProgress: true,
                thumbs: { swiper: modalThumbsSwiper },
                navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
                pagination: { el: '.swiper-pagination', clickable: true },
                allowTouchMove: true,
                on: {
                    slideChangeTransitionStart: function () {
                        var previousSlide = $(this.slides[this.previousIndex]);
                        var iframeContainer = previousSlide.find('.iframe-video');
                        iframeContainer.addClass('d-none');
                        iframeContainer.find('iframe').attr('src', '');
                    },
                    slideChangeTransitionEnd: function () {
                        var activeSlide = $(this.slides[this.activeIndex]);
                        var playIcon = activeSlide.find('#main-video-icon');
                        if (playIcon.length) playIcon.trigger('click');
                    }
                }
            });
        }
    };

    // ========================================================
    // PhotoSwipe
    // ========================================================
    var openPhotoSwiper = function (images, index) {
        var pswpElement = document.querySelectorAll('.pswp')[0];
        if (!pswpElement) return;
        var items = images.map(function (src) { return { src: src, w: 1200, h: 900 }; });
        var options = {
            history: false, focus: false,
            showAnimationDuration: 0, hideAnimationDuration: 0,
            index: parseInt('' + index) || 0
        };
        if (typeof PhotoSwipe !== 'undefined' && typeof PhotoSwipeUI_Default !== 'undefined') {
            var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);
            gallery.listen('close', function () {
                $('.pswp').addClass('d-hide');
                $('.app').removeClass('d-hide');
            });
            gallery.init();
        }
    };

    // ========================================================
    // Event Listeners
    // ========================================================
    $(document).on('click', '#product-images-slick .image-link', function (event) {
        if ($(event.target).is('#main-video-icon')) return;
        $('.pswp').removeClass('d-hide');
        $('.app').addClass('d-hide');
        var index = $('#product-images-slick .swiper-slide-active').attr('data-swiper-slide-index') || 0;
        openPhotoSwiper(productImages.map(function (img) { return img.image.full_size; }), index);
    });

    $(document).on('click', '.variant-image-wrapper a', function (event) {
        $('.pswp').removeClass('d-hide');
        $('.app').addClass('d-hide');
        var elm = event.currentTarget;
        var varId = $(elm).attr('data-link-var-id');
        var images = [];
        $("div[data-var-id='" + varId + "'] img").each(function () {
            var url = $(this).attr('data-image-url');
            if (url) images.push(url);
        });
        openPhotoSwiper(images, parseInt($(elm).attr('data-index')) || 0);
    });

    // ========================================================
    // DOM Ready
    // ========================================================
    $(document).ready(function () {
        if (productImages && productImages.length > 0) {
            initSlick(productImages);
        }
        applyFixedMediaHeightFromFirst();
        if (customerWishlistIds && Array.isArray(customerWishlistIds)) {
            if (typeof fillWishlistItems === 'function') {
                fillWishlistItems(customerWishlistIds.map(function (id) { return { id: id }; }));
            }
        }
    });

    $('#product-images-slick').on('init', function () {
        $('.product-images-carousel').removeClass('product-images-carousel-init');
    });

    // تشغيل الفيديو عند تحميل الصفحة إن وُجد
    $(document).ready(function () {
        setTimeout(function () {
            var activeSlide = $('#product-images-slick .swiper-slide-active .image-link');
            var playIcon = activeSlide.find('#main-video-icon');
            if (playIcon.length) playIcon.trigger('click');
        }, 250);
    });

    // ========================================================
    // إدارة الكمية (+ / -)
    // ========================================================
    $(document).ready(function () {
        var $allQuantityInputs = $('.select-quantity');
        var maxQuantity = {% if product.selected_product.is_infinite or product.selected_product.quantity > 100 %}100{% else %}{{ product.selected_product.quantity }}{% endif %};

        $(document).on('click', '.btn-quantity', function () {
            var isIncrease = $(this).attr('id') === 'increase-quantity';
            var currentValue = parseInt($allQuantityInputs.first().val()) || 1;
            if (isIncrease && currentValue < maxQuantity) {
                currentValue++;
            } else if (!isIncrease && currentValue > 1) {
                currentValue--;
            }
            $allQuantityInputs.val(currentValue);
        });
    });

    // ========================================================
    // بيانات العميل عند جلبها (تعبئة نموذج الإشعار)
    // ========================================================
    document.addEventListener('zid-customer-fetched', function (event) {
        var customer = event.detail.customer;
        if (customer && customer.mobile) {
            $('.send-notify-name').val(customer.name || '');
            $('.send-notify-email').val(customer.email || '');
            $('.send-notify-country-key').val(customer.mobile.substring(0, 3) || '966');
            $('.send-notify-phone').val(customer.mobile.substring(3) || '');
        }
    });

    // ========================================================
    // Video Iframe helpers
    // ========================================================
    function getIframeLink(videoLink) {
        if (!videoLink || typeof videoLink !== 'string') return null;
        var videoIdMatch = videoLink.match(
            /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?|.*[?&]v=)|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/
        );
        if (videoIdMatch && videoIdMatch[1]) {
            return 'https://www.youtube.com/embed/' + videoIdMatch[1] + '?autoplay=1&enablejsapi=1';
        }
        return null;
    }

    function showIframe(elm, imageVideoSrc) {
        if (!elm || !imageVideoSrc) return;
        var iframeLink = getIframeLink(imageVideoSrc);
        if (!iframeLink) return;
        var iframeContainer = $(elm).closest('.swiper-slide').find('.iframe-video');
        var iframeElem = iframeContainer.find('iframe');
        iframeContainer.removeClass('d-none');
        if (iframeElem.attr('src') !== iframeLink) {
            iframeElem.attr('src', iframeLink);
        }
    }

    function hideIframe(elm) {
        if (!elm) return;
        var iframeContainer = $(elm).closest('.iframe-video');
        iframeContainer.addClass('d-none');
        iframeContainer.find('iframe').attr('src', '');
    }
</script>

{% endblock %}