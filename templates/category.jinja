{% extends "layout.jinja" %}

{% block header %} {% include 'header.jinja' %} {% endblock %}

{% block top_links %}
<link rel="stylesheet" type="text/css" href="{{ 'toastr.min.css' | asset_url }}" />
{% endblock %}

{% block main_content %}

{% if banner_list is defined and banner_list is not none and banner_list is iterable %}
    {% for item in banner_list %}
        {% if item.choose_category.id == category.id %}
        <div class="container">
            <img loading="lazy" class="category-cover-img" src="{{ image_url(item.banner, w=1920, q=100, f='auto') }}"
                alt="category_banner">
        </div>
        {% endif %}
    {% endfor %}
{% endif %}

<div class="breadcrumb-subtitle">
    <section class="breadcrumb-section">
        <nav aria-label="breadcrumb">
            <div class="container">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item" aria-current="page">
                        <a href="/">{{ _("Home") }}</a>
                    </li>
                    {% if category.parent_category.parent_category %}
                    <li class="breadcrumb-item" aria-current="page">
                        <a href="{{ category.parent_category.parent_category.url }}">{{
                            category.parent_category.parent_category.name }}</a>
                    </li>
                    {% endif %}

                    {% if category.parent_category %}
                    <li class="breadcrumb-item" aria-current="page">
                        <a href="{{ category.parent_category.url }}">{{ category.parent_category.name }}</a>
                    </li>
                    {% endif %}

                    <li class="breadcrumb-item active " aria-current="page">{{ category.name }}</li>
                </ol>
            </div>
        </nav>
    </section>

    {% set title=category.name %}
    {% set description=category.description %}
    {% set img=category.image %}
    {% include 'components/breadcrumb-subTitle-detail.jinja' %}
</div>


{% if category.sub_categories | length > 0 %}
<div class="container">
    <div class="home-categories-section">
        <div class="tp-category-swiper swiper-container">
            <div class="swiper-wrapper">
                {% for categoryItem in category.sub_categories %}
                <div class="swiper-slide">
                    <div class="tp-product-category-item">
                        {% if categoryItem.image %}
                        <div class="tp-product-category-thumb fix">
                            <a href="/categories/{{ categoryItem.id }}/{{ categoryItem.slug }}">
                            <img loading="lazy" src="{{ imageUrl(categoryItem.image, { w: 235, q: 100, f:'auto' }) }}" alt="{{ categoryItem.name }}">
                            </a>
                        </div>
                        {% endif %} 
                        <div class="tp-product-category-content">
                            <h2 class="tp-product-category-title">
                                <a href="/categories/{{ categoryItem.id }}/{{ categoryItem.slug }}">{{ categoryItem.name }}</a>
                            </h2>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

     <script>
          document.addEventListener("DOMContentLoaded", function () {
            var catgSlider = new Swiper(".tp-category-swiper", {
              slidesPerView: "auto",
              spaceBetween: 16,
              freeMode: true,
              autoplay: {
                delay: 3000,
              },
              navigation: {
                nextEl: ".tp-slider-button-next",
                prevEl: ".tp-slider-button-prev",
              },
              breakpoints: {
                0: {
                  spaceBetween: 10,
                  slidesPerView: "auto",
                },
                768: {
                  slidesPerView: "auto",
                  spaceBetween: 16,
                },
              },
            });
        });
      </script>
</div>
{% endif %}

<div class="container">
    <div class="products-filters-box">
        {% if products.filters|length > 0 %}
        {% set async=true %} {% include 'vitrin:products/filters.jinja' %}
        {% endif %}

        <div class="products-container">
            <div>
                {% set count=products.count %}
                {% set has_products_filtration=(products.filters|length > 0) %}
                {% include 'components/products-filter.jinja' %}
            </div>

            <div id="products-list" class="products-grid">
                {% for product in products.results %}
                {% set product=product %}{% set index=loop.index0 %}{% include 'components/product-card.jinja' %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="text-center pb-5">
    <button id="load-more-button" class="load-more-button tp-btn tp-btn-primary"
        data-pages="{{ products.pages_count }}">
        <span class="btn-loader d-none">
            <span class="loader-more"></span>
        </span>
        <span class="btn-label">{{ _("Load More") }}</span>
    </button>
</div>

<div class="container">
    {% set entity = category %}
    {% include 'vitrin:shared/metafields.jinja' %}
</div>

{% endblock %}

{% block footer %} {% include 'footer.jinja' %} {% endblock %}


{% block footer_scripts %}
<script type="text/javascript" src="{{ 'toastr.min.js' | asset_url }}" defer></script>
<script>
    window.onProductAttributesTriggered = function () {
        $('#products-list').css('opacity', '0.4');
        $('#load-more-button').css('opacity', '0');
    }

    window.onProductAttributesChanged = function (htmlStr) {
        var html = $.parseHTML(htmlStr);
        $('#products-list').html($('#products-list', html).html());
        $('#products-list').css('opacity', '1');
        $('#product-filter-count').html($('#product-filter-count', html).html());
        $('#product-filter-count').css('opacity', '1');

        if ($('#product-pagination', html).length > 0) {
            $('#product-pagination').html($('#product-pagination', html).html());
            $('#product-pagination').css('opacity', '1');
        }
    }
</script>

<script type="text/javascript" src="{{ 'load-more.js' | asset_url }}" defer></script>

<script>
    // noUiSlider setup for price filter
    function loadNoUiSlider(callback) {
        let link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = "https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css";
        document.head.appendChild(link);

        let script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js";
        script.onload = callback;
        document.body.appendChild(script);
    }

    loadNoUiSlider(() => {
        const priceSection = document.querySelector(".form-products-filter .flex-div");
        if (!priceSection) return;

        const sliderContainer = document.createElement("div");
        sliderContainer.id = "price-slider";
        sliderContainer.style.margin = "20px 10px";
        priceSection.insertAdjacentElement("afterend", sliderContainer);

        const fromPriceInput = document.querySelector('input[name="price_min"]');
        const toPriceInput = document.querySelector('input[name="price_max"]');
        if (!fromPriceInput || !toPriceInput) return;

        noUiSlider.create(sliderContainer, {
            start: [parseFloat(fromPriceInput.value) || 0, parseFloat(toPriceInput.value) || 5000],
            connect: true,
            direction: "{{ session.locale.language.direction }}",
            range: { 'min': 0, 'max': 9000 },
            step: 10,
        });

        sliderContainer.noUiSlider.on("update", (values) => {
            fromPriceInput.value = Math.round(values[0]);
            toPriceInput.value = Math.round(values[1]);
        });

        const updateSlider = () => {
            sliderContainer.noUiSlider.set([fromPriceInput.value, toPriceInput.value]);
        };

        fromPriceInput.addEventListener("change", updateSlider);
        toPriceInput.addEventListener("change", updateSlider);
    });

    // Filter toggle and overlay
    document.addEventListener("DOMContentLoaded", function () {
        const filterButton = document.querySelector('.open-close-filter');
        const productAttributes = document.querySelector('.product-attributes');
        const overlayFilter = document.querySelector('.overlay-filter');
        const filtrationHeader = document.querySelector('.filtration-header');

        if (filterButton && productAttributes) {
            filterButton.addEventListener('click', () => {
                productAttributes.classList.toggle('hide-filter');
                if (window.innerWidth <= 1200 && overlayFilter) {
                    overlayFilter.classList.toggle('active');
                    if (filtrationHeader && !filtrationHeader.querySelector('em')) {
                        const emElement = document.createElement('em');
                        filtrationHeader.appendChild(emElement);
                        emElement.addEventListener('click', () => {
                            productAttributes.classList.remove('hide-filter');
                            overlayFilter.classList.remove('active');
                        });
                    }
                }
            });
        }

        if (overlayFilter) {
            overlayFilter.addEventListener('click', () => {
                productAttributes.classList.remove('hide-filter');
                overlayFilter.classList.remove('active');
            });
        }
    });
</script>
{% endblock %}